let filepath = "/home/stratos/projects/aoc2025/fpga/hardcaml/input.txt"

(* Set these based on the input file *)
(* m Must be a divisor of num_lines *)
module TestConfig = struct
  let num_digits = 100
  let num_lines = 200
  let select_digits = 12
  let m = 10
end

open! Core
open! Hardcaml
open! Hardcaml_waveterm
open! Hardcaml_test_harness
module TOP = Aoc25.Day_3_top.Make (TestConfig)
module Harness = Cyclesim_harness.Make (TOP.I) (TOP.O)

let ( <--. ) = Bits.( <--. )

(* AI Generated function *)
let read_matrix_by_digit filename =
  In_channel.read_lines filename
  |> List.filter ~f:(fun s -> not (String.is_empty (String.strip s)))
  |> List.map ~f:(fun line ->
    (* Convert the string into a list of characters *)
    let chars = String.to_list (String.strip line) in
    (* Convert each character '1' -> 1, '2' -> 2, etc. *)
    List.map chars ~f:(fun c ->
      let digit = Char.to_int c - Char.to_int '0' in
      if digit < 0 || digit > 9
      then failwith (Printf.sprintf "Invalid digit found in file: %c" c)
      else digit))
;;

(* Read input from file *)
let read_lines filename = In_channel.read_lines filename |> List.map ~f:String.strip

(* THIS FUNCTION WAS FULLY AI GENERATED *)
(* Bounded monotonic stack algorithm *)
let monotonic_stack_bounded line k =
  let n = String.length line in
  let to_remove = ref (n - k) in
  (* Store digits in REVERSE order so HEAD is the most recent *)
  let stack = ref [] in
  String.iter line ~f:(fun digit ->
    (* Peek at the HEAD (most recent) *)
    while
      (not (List.is_empty !stack)) && !to_remove > 0 && Char.(List.hd_exn !stack < digit)
    do
      stack := List.tl_exn !stack;
      (* Pop the HEAD *)
      to_remove := !to_remove - 1
    done;
    stack := digit :: !stack (* Push to the HEAD *));
  (* Since we built it backwards, Reverse it at the end *)
  let correct_order = List.rev !stack in
  (* Truncate to k if we didn't spend all our removal budget *)
  let final_digits = List.take correct_order k in
  Int.of_string (String.of_char_list final_digits)
;;

let solve lines =
  let process_bank line = monotonic_stack_bounded line 12 in
  List.fold lines ~init:0 ~f:(fun acc line -> acc + process_bank line)
;;

let model_solve filename =
  let lines = read_lines filename in
  let ans = solve lines in
  printf "MODEL RESULT: %d \n" ans
;;

let simple_testbench (sim : Harness.Sim.t) =
  printf "DAY 3 PART 2 TEST \n";
  model_solve filepath;
  let arr = read_matrix_by_digit filepath in
  let inputs = Cyclesim.inputs sim in
  let outputs = Cyclesim.outputs sim in
  let cycles = ref 0 in
  (* Define a helper to use instead of Cyclesim.cycle *)
  let tick () =
    Cyclesim.cycle sim;
    Int.incr cycles
  in
  (* Helper function for inputting one value *)
  let feed_input n =
    inputs.data_in <--. n;
    inputs.valid := Bits.vdd;
    while not (Bits.to_bool !(outputs.ready)) do
      tick ()
    done;
    tick ();
    inputs.valid := Bits.gnd
  in
  let feed_array_chunked z ~chunk_size =
    let open Hardcaml.Bits in
    let bit_width = 4 in
    let chunk_list = List.chunks_of ~length:chunk_size in
    let transpose matrix =
      match matrix with
      | [] -> []
      | first :: _ ->
        List.init (List.length first) ~f:(fun i ->
          List.map matrix ~f:(fun row -> List.nth_exn row i))
    in
    (* Convert to Bits *)
    let bit_matrix =
      List.map z ~f:(fun row -> List.map row ~f:(of_int_trunc ~width:bit_width))
    in
    (* Chunk rows *)
    let row_chunks = chunk_list bit_matrix in
    (* Process each chunk *)
    let processed_rows =
      List.map row_chunks ~f:(fun chunk ->
        let columns = transpose chunk in
        List.map columns ~f:concat_msb)
    in
    (* Feed to simulation *)
    List.iter processed_rows ~f:(fun row ->
      List.iter row ~f:(fun val_bits -> feed_input (to_int_trunc val_bits)))
  in
  (* Reset the design *)
  inputs.clear := Bits.vdd;
  tick ();
  inputs.clear := Bits.gnd;
  tick ();
  (* Pulse the start signal *)
  inputs.start := Bits.vdd;
  tick ();
  inputs.start := Bits.gnd;
  (* Input some data *)
  feed_array_chunked arr ~chunk_size:TestConfig.m;
  while not (Bits.to_bool !(outputs.ddone)) do
    tick ()
  done;
  printf "HARDWARE RESULT: %d \n" (Bits.to_int_trunc !(outputs.result));
  printf "Simulation completed in %d cycles.\n%!" !cycles
;;

(* The [waves_config] argument to [Harness.run] determines where and how to save waveforms
   for viewing later with a waveform viewer. The commented examples below show how to save
   a waveterm file or a VCD file. *)

(* let waves_config = *)
(*   Waves_config.to_directory "/tmp/" *)
(*   |> Waves_config.as_wavefile_format ~format:Vcd *)
(* ;; *)

let%expect_test "Simple test, optionally saving waveforms to disk" =
  Harness.run_advanced ~create:TOP.hierarchical simple_testbench;
  [%expect
    {|
    DAY 3 PART 2 TEST
    MODEL RESULT: 168794698570517
    HARDWARE RESULT: 168794698570517
    Simulation completed in 15907 cycles.
    |}]
;;

let%expect_test "Simple test with printing waveforms directly" =
  (* For simple tests, we can print the waveforms directly in an expect-test (and use the
     command [dune promote] to update it after the tests run). This is useful for quickly
     visualizing or documenting a simple circuit, but limits the amount of data that can
     be shown. *)
  let display_rules =
    [ Display_rule.port_name_matches
        ~wave_format:(Bit_or Unsigned_int)
        (Re.Glob.glob "top*" |> Re.compile)
    ]
  in
  Harness.run_advanced
    ~create:TOP.hierarchical
    ~trace:`Everything
    ~print_waves_after_test:(fun waves ->
      Waveform.print
        ~display_rules
          (* [display_rules] is optional, if not specified, it will print all named
             signals in the design. *)
        ~signals_width:30
        ~display_width:92
        ~wave_width:1
        (* [wave_width] configures how many chars wide each clock cycle is *)
        waves)
    simple_testbench;
  [%expect
    {|
    DAY 3 PART 2 TEST
    MODEL RESULT: 168794698570517
    HARDWARE RESULT: 168794698570517
    Simulation completed in 15907 cycles.
    ┌Signals─────────────────────┐┌Waves───────────────────────────────────────────────────────┐
    │top$i$clear                 ││────┐                                                       │
    │                            ││    └───────────────────────────────────────────────────────│
    │top$i$clock                 ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                            ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                            ││────────────┬───────┬───────────┬───────────────────┬───────│
    │top$i$data_in               ││ 0          │146870.│1468869593.│215338848802       │147442.│
    │                            ││────────────┴───────┴───────────┴───────────────────┴───────│
    │top$i$start                 ││        ┌───┐                                               │
    │                            ││────────┘   └───────────────────────────────────────────────│
    │top$i$valid                 ││            ┌───────────────────────────────────────────────│
    │                            ││────────────┘                                               │
    │top$o$ddone                 ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$o$ready                 ││                ┌───┐       ┌───┐               ┌───┐       │
    │                            ││────────────────┘   └───────┘   └───────────────┘   └───────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$o$result                ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$acc             ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$acc_1           ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$count           ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────┬───────────┬───────────────────┬───────│
    │top$pe_0$pe$digit_cnt       ││ 0                  │1          │2                  │3      │
    │                            ││────────────────────┴───────────┴───────────────────┴───────│
    │top$pe_0$pe$done_o          ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$i$acc_in        ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$i$clear         ││────┐                                                       │
    │                            ││    └───────────────────────────────────────────────────────│
    │top$pe_0$pe$i$clock         ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                            ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                            ││────────────┬───────┬───────────┬───────────────────┬───────│
    │top$pe_0$pe$i$data_in       ││ 0          │2      │1          │2                  │7      │
    │                            ││────────────┴───────┴───────────┴───────────────────┴───────│
    │top$pe_0$pe$i$data_in_valid ││                ┌───┐       ┌───┐               ┌───┐       │
    │                            ││────────────────┘   └───────┘   └───────────────┘   └───────│
    │top$pe_0$pe$i$do_acc        ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$i$push_acc      ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$i$start         ││            ┌───┐                                           │
    │                            ││────────────┘   └───────────────────────────────────────────│
    │top$pe_0$pe$is_stack_empty  ││                ┌───────┐                                   │
    │                            ││────────────────┘       └───────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$lacc_cnt        ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$line_cnt        ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$o$acc           ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$o$done_o        ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$o$ready         ││                ┌───┐       ┌───┐       ┌───────────┐       │
    │                            ││────────────────┘   └───────┘   └───────┘           └───────│
    │                            ││────────────────────┬───────────┬───────────────────┬───────│
    │top$pe_0$pe$rdata           ││ 0                  │2          │1                  │2      │
    │                            ││────────────────────┴───────────┴───────────────────┴───────│
    │top$pe_0$pe$ready           ││                ┌───┐       ┌───┐       ┌───────────┐       │
    │                            ││────────────────┘   └───────┘   └───────┘           └───────│
    │                            ││────────────────┬───────────────────────────────────────┬───│
    │top$pe_0$pe$remove_num      ││ 0              │88                                     │87 │
    │                            ││────────────────┴───────────────────────────────────────┴───│
    │                            ││────────────────────────┬───────────┬───────────────────┬───│
    │top$pe_0$pe$stack_idx       ││ 0                      │1          │2                  │1  │
    │                            ││────────────────────────┴───────────┴───────────────────┴───│
    │top$pe_0$pe$start_acc       ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_0$pe$zero_acc        ││        ┌───────┐                                           │
    │                            ││────────┘       └───────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$acc             ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$acc_1           ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$count           ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────┬───────────┬───────────────────┬───────│
    │top$pe_1$pe$digit_cnt       ││ 0                  │1          │2                  │3      │
    │                            ││────────────────────┴───────────┴───────────────────┴───────│
    │top$pe_1$pe$done_o          ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$i$acc_in        ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$i$clear         ││────┐                                                       │
    │                            ││    └───────────────────────────────────────────────────────│
    │top$pe_1$pe$i$clock         ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                            ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                            ││────────────┬───────┬───────────────────────────────────────│
    │top$pe_1$pe$i$data_in       ││ 0          │8      │2                                      │
    │                            ││────────────┴───────┴───────────────────────────────────────│
    │top$pe_1$pe$i$data_in_valid ││                ┌───┐       ┌───┐               ┌───┐       │
    │                            ││────────────────┘   └───────┘   └───────────────┘   └───────│
    │top$pe_1$pe$i$do_acc        ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$i$push_acc      ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$i$start         ││            ┌───┐                                           │
    │                            ││────────────┘   └───────────────────────────────────────────│
    │top$pe_1$pe$is_stack_empty  ││                ┌───────┐                                   │
    │                            ││────────────────┘       └───────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$lacc_cnt        ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$line_cnt        ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$o$acc           ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$o$done_o        ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$o$ready         ││                ┌───┐       ┌───┐       ┌───────────┐       │
    │                            ││────────────────┘   └───────┘   └───────┘           └───────│
    │                            ││────────────────────┬───────────┬───────────────────────────│
    │top$pe_1$pe$rdata           ││ 0                  │8          │2                          │
    │                            ││────────────────────┴───────────┴───────────────────────────│
    │top$pe_1$pe$ready           ││                ┌───┐       ┌───┐       ┌───────────┐       │
    │                            ││────────────────┘   └───────┘   └───────┘           └───────│
    │                            ││────────────────┬───────────────────────────────────────────│
    │top$pe_1$pe$remove_num      ││ 0              │88                                         │
    │                            ││────────────────┴───────────────────────────────────────────│
    │                            ││────────────────────────┬───────────┬───────────────────┬───│
    │top$pe_1$pe$stack_idx       ││ 0                      │1          │2                  │3  │
    │                            ││────────────────────────┴───────────┴───────────────────┴───│
    │top$pe_1$pe$start_acc       ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_1$pe$zero_acc        ││        ┌───────┐                                           │
    │                            ││────────┘       └───────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$acc             ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$acc_1           ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$count           ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────┬───────────┬───────────────────┬───────│
    │top$pe_2$pe$digit_cnt       ││ 0                  │1          │2                  │3      │
    │                            ││────────────────────┴───────────┴───────────────────┴───────│
    │top$pe_2$pe$done_o          ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$i$acc_in        ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$i$clear         ││────┐                                                       │
    │                            ││    └───────────────────────────────────────────────────────│
    │top$pe_2$pe$i$clock         ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                            ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                            ││────────────┬───────┬───────────┬───────────────────────────│
    │top$pe_2$pe$i$data_in       ││ 0          │2      │1          │2                          │
    │                            ││────────────┴───────┴───────────┴───────────────────────────│
    │top$pe_2$pe$i$data_in_valid ││                ┌───┐       ┌───┐               ┌───┐       │
    │                            ││────────────────┘   └───────┘   └───────────────┘   └───────│
    │top$pe_2$pe$i$do_acc        ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$i$push_acc      ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$i$start         ││            ┌───┐                                           │
    │                            ││────────────┘   └───────────────────────────────────────────│
    │top$pe_2$pe$is_stack_empty  ││                ┌───────┐                                   │
    │                            ││────────────────┘       └───────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$lacc_cnt        ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$line_cnt        ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$o$acc           ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$o$done_o        ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$o$ready         ││                ┌───┐       ┌───┐       ┌───────────┐       │
    │                            ││────────────────┘   └───────┘   └───────┘           └───────│
    │                            ││────────────────────┬───────────┬───────────────────┬───────│
    │top$pe_2$pe$rdata           ││ 0                  │2          │1                  │2      │
    │                            ││────────────────────┴───────────┴───────────────────┴───────│
    │top$pe_2$pe$ready           ││                ┌───┐       ┌───┐       ┌───────────┐       │
    │                            ││────────────────┘   └───────┘   └───────┘           └───────│
    │                            ││────────────────┬───────────────────────────────────────┬───│
    │top$pe_2$pe$remove_num      ││ 0              │88                                     │87 │
    │                            ││────────────────┴───────────────────────────────────────┴───│
    │                            ││────────────────────────┬───────────┬───────────────────┬───│
    │top$pe_2$pe$stack_idx       ││ 0                      │1          │2                  │1  │
    │                            ││────────────────────────┴───────────┴───────────────────┴───│
    │top$pe_2$pe$start_acc       ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_2$pe$zero_acc        ││        ┌───────┐                                           │
    │                            ││────────┘       └───────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_3$pe$acc             ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_3$pe$acc_1           ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_3$pe$count           ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────┬───────────┬───────────────────┬───────│
    │top$pe_3$pe$digit_cnt       ││ 0                  │1          │2                  │3      │
    │                            ││────────────────────┴───────────┴───────────────────┴───────│
    │top$pe_3$pe$done_o          ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_3$pe$i$acc_in        ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_3$pe$i$clear         ││────┐                                                       │
    │                            ││    └───────────────────────────────────────────────────────│
    │top$pe_3$pe$i$clock         ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                            ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                            ││────────────┬───────────────────┬───────────────────┬───────│
    │top$pe_3$pe$i$data_in       ││ 0          │2                  │1                  │4      │
    │                            ││────────────┴───────────────────┴───────────────────┴───────│
    │top$pe_3$pe$i$data_in_valid ││                ┌───┐       ┌───┐               ┌───┐       │
    │                            ││────────────────┘   └───────┘   └───────────────┘   └───────│
    │top$pe_3$pe$i$do_acc        ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_3$pe$i$push_acc      ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_3$pe$i$start         ││            ┌───┐                                           │
    │                            ││────────────┘   └───────────────────────────────────────────│
    │top$pe_3$pe$is_stack_empty  ││                ┌───────┐                                   │
    │                            ││────────────────┘       └───────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_3$pe$lacc_cnt        ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_3$pe$line_cnt        ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_3$pe$o$acc           ││ 0                                                          │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_3$pe$o$done_o        ││                                                            │
    │                            ││────────────────────────────────────────────────────────────│
    │top$pe_3$pe$o$ready         ││                ┌───┐       ┌───┐       ┌───────────┐       │
    │                            ││────────────────┘   └───────┘   └───────┘           └───────│
    │                            ││────────────────────┬───────────────────────────────┬───────│
    │top$pe_3$pe$rdata           ││ 0                  │2                              │1      │
    │                            ││────────────────────┴───────────────────────────────┴───────│
    └────────────────────────────┘└────────────────────────────────────────────────────────────┘
    |}]
;;
